
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "gallery/lop/deblurring.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download_gallery_lop_deblurring.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_gallery_lop_deblurring.py:


Image Deblurring
===========================

This example demonstrates following features:

- ``cr.sparse.lop.convolve2D`` A 2D convolution linear operator
- ``cr.sparse.sls.lsqr`` LSQR algorithm for solving a least square problem on 2D images

Image deblurring can be treated as a deconvolution problem if the filter used
for blurring the image is known.

Please see the deconvolution example for some background.

.. GENERATED FROM PYTHON SOURCE LINES 18-19

Let's import necessary libraries 

.. GENERATED FROM PYTHON SOURCE LINES 19-36

.. code-block:: default

    import jax.numpy as jnp
    # For plotting diagrams
    import matplotlib.pyplot as plt
    ## CR-Sparse modules
    import cr.sparse as crs
    # Linear operators
    from cr.sparse import lop
    # Image processing utilities
    from cr.sparse import vision
    # Solvers for sparse linear systems
    from cr.sparse import sls
    # Sample images
    import skimage.data
    # Configure JAX for 64-bit computing
    from jax.config import config
    config.update("jax_enable_x64", True)








.. GENERATED FROM PYTHON SOURCE LINES 37-39

Problem Setup
------------------

.. GENERATED FROM PYTHON SOURCE LINES 39-43

.. code-block:: default

    image = skimage.data.checkerboard()
    print(image.shape)






.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    (200, 200)




.. GENERATED FROM PYTHON SOURCE LINES 44-46

Gaussian blur kernel
----------------------

.. GENERATED FROM PYTHON SOURCE LINES 46-54

.. code-block:: default

    h  = vision.kernel_gaussian((15,25), (8,4))
    # plot the kernel
    fig, ax = plt.subplots(1, 1, figsize=(5, 3))
    him = ax.imshow(h)
    ax.set_title('Blurring kernel')
    fig.colorbar(him, ax=ax)
    ax.axis('tight')




.. image:: /gallery/lop/images/sphx_glr_deblurring_001.png
    :alt: Blurring kernel
    :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none


    (-0.5, 24.5, 14.5, -0.5)



.. GENERATED FROM PYTHON SOURCE LINES 55-58

The linear operator for the blur kernel
''''''''''''''''''''''''''''''''''''''''''''''''''''''
Locate the center of the filter

.. GENERATED FROM PYTHON SOURCE LINES 58-65

.. code-block:: default

    offset = crs.arr_largest_index(h)
    print(offset)
    # Construct a 2D convolution operator based on the kernel
    H = lop.convolve2D(image.shape, h, offset=offset)
    # JIT compile the convolution operator for efficiency
    H = lop.jit(H)





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    (DeviceArray(7, dtype=int64), DeviceArray(12, dtype=int64))




.. GENERATED FROM PYTHON SOURCE LINES 66-69

The blurring
''''''''''''''''''''''''''''''''''''''''''''''''''''''
Apply the blurring operator to the original image 

.. GENERATED FROM PYTHON SOURCE LINES 69-77

.. code-block:: default

    blurred_image = H.times(image)
    # plot the original and the blurred images
    fig, ax = plt.subplots(ncols=2, figsize=(10, 5))
    ax[0].imshow(image, cmap=plt.cm.gray)
    ax[0].set_title('Original')
    ax[1].imshow(blurred_image, cmap=plt.cm.gray)
    ax[1].set_title('After blurring')




.. image:: /gallery/lop/images/sphx_glr_deblurring_002.png
    :alt: Original, After blurring
    :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none


    Text(0.5, 1.0, 'After blurring')



.. GENERATED FROM PYTHON SOURCE LINES 78-81

The deblurring using LSQR algorithm
''''''''''''''''''''''''''''''''''''''''''''''''''''''
An initial guess of the deblurred image is all zeros

.. GENERATED FROM PYTHON SOURCE LINES 81-95

.. code-block:: default

    x0 = jnp.zeros_like(blurred_image)
    # We run LSQR algorithm to deblur the image for 50 iterations
    sol = sls.lsqr(H, blurred_image, x0, max_iters=50)
    deblurred_image = sol.x
    # Plot the original, blurred and deblurred image
    fig, ax = plt.subplots(ncols=3, figsize=(15, 5))
    ax[0].imshow(image, cmap=plt.cm.gray)
    ax[0].set_title('Original')
    ax[1].imshow(blurred_image, cmap=plt.cm.gray)
    ax[1].set_title('After blurring')
    ax[2].imshow(deblurred_image, cmap=plt.cm.gray)
    ax[2].set_title('After deblurring')

    print(sol)



.. image:: /gallery/lop/images/sphx_glr_deblurring_003.png
    :alt: Original, After blurring, After deblurring
    :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    x: (200, 200)
    A_norm: 4.946758875785471
    A_cond: 167.3069908856023
    x_norm: 34971.66794553036
    r_norm: 28.394130441228945
    atr_norm: 3.8161913539049293
    iterations: 50
    n_times: 50
    n_trans: 50





.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  4.068 seconds)


.. _sphx_glr_download_gallery_lop_deblurring.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download sphx-glr-download-python

     :download:`Download Python source code: deblurring.py <deblurring.py>`



  .. container:: sphx-glr-download sphx-glr-download-jupyter

     :download:`Download Jupyter notebook: deblurring.ipynb <deblurring.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
